#!/usr/bin/env bash
RDIFF=rdiff-backup

# our only argument is the destination
DEST="${1}"

# configuration options
SOURCE='/'
VERBOSITY=5
KEEP_FOR=3M

# the file used to notify that a system backup is happening
lockdir="/tmp/backup.lock"

# information files for the current backup process
pid_file="${lockdir}/pid"
start_date_file="${lockdir}/start-date"

# if the user requested the status of the backup, print the status and exit
if [[ "${1}" == "-s" ]] || [[ "${1}" == "--status" ]]; then
  if [ -e "${lockdir}" ]; then
    # if the user supplied a custom string, print it
    custom_message="${2}"
    if [ ! -z "${custom_message}" ]; then
      echo "${custom_message}"
    fi

    # exit with success indicating that a backup is happening
    exit 0
  else
    # notify that there's no backup in progress, but print no message
    exit 1
  fi
fi

# exit if we can't grab our lock
if ! mkdir "${lockdir}" &> /dev/null; then
  echo "Backup already in progress:"
  echo "  Started: $(cat ${start_date_file})"
  echo "      PID: $(cat ${pid_file})"
  echo "Exiting."
  exit 1
fi

# always remove the lock directory we just created on exit, no matter what.
# however, this is set after the lock to ensure that we don't spurriously remove
# another process's lock!
trap "rm -rf ${lockdir}" INT QUIT TERM EXIT

# store useful info about this backup in the the lock directory
echo "$BASHPID" > "${pid_file}"
echo "$(date)" > "${start_date_file}"

echo "Backing up '${SOURCE}' to '${DEST}'..."
echo

${RDIFF} \
  --exclude '/home/*/.cache' \
  --include '/home' \
  --exclude '/tmp/*' \
  --exclude '/var/tmp/*' \
  --exclude '/proc/*' \
  --exclude '/sys/*' \
  --exclude '/mnt/*/*' \
  --exclude-special-files \
  --exclude-other-filesystems \
  --verbosity "${VERBOSITY}" \
  "${SOURCE}" "${DEST}"

echo
echo "Purging old backups in '${DEST}'..."
echo

${RDIFF} \
  --remove-older-than "${KEEP_FOR}" \
  --force \
  --verbosity "${VERBOSITY}" \
  "${DEST}"
